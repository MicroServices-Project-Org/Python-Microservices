name: Docker Validation

on:
  push:
    branches: ["main", "develop"]
    paths:
      - "docker-compose.yml"
      - "docker/**"
      - "**/Dockerfile"
  pull_request:
    branches: ["main", "develop"]
    paths:
      - "docker-compose.yml"
      - "docker/**"
      - "**/Dockerfile"

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 â€” Validate docker-compose.yml
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-compose:
    name: Validate docker-compose.yml
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: docker compose config --quiet

      - name: Check all services are defined
        run: |
          REQUIRED_SERVICES=(
            "mongodb"
            "postgres"
            "zookeeper"
            "kafka"
            "kafka-ui"
            "keycloak"
            "prometheus"
            "grafana"
            "loki"
            "tempo"
            "promtail"
          )
          for svc in "${REQUIRED_SERVICES[@]}"; do
            if docker compose config --services | grep -q "^${svc}$"; then
              echo "âœ… $svc found"
            else
              echo "âŒ $svc is MISSING from docker-compose.yml"
              exit 1
            fi
          done

      - name: Check all required volumes are defined
        run: |
          REQUIRED_VOLUMES=(
            "mongo_data"
            "postgres_data"
            "prometheus_data"
            "grafana_data"
            "loki_data"
            "tempo_data"
          )
          for vol in "${REQUIRED_VOLUMES[@]}"; do
            if docker compose config | grep -q "${vol}:"; then
              echo "âœ… Volume $vol found"
            else
              echo "âŒ Volume $vol is MISSING"
              exit 1
            fi
          done

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 â€” Lint Dockerfiles (hadolint)
  # Runs only when Dockerfiles exist in the repo
  # Automatically picks up new service Dockerfiles
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find all Dockerfiles
        id: find
        run: |
          FILES=$(find . -name "Dockerfile" | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
          if [ -z "$FILES" ]; then
            echo "no_dockerfiles=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Dockerfiles found yet â€” skipping lint"
          else
            echo "no_dockerfiles=false" >> $GITHUB_OUTPUT
            echo "Found Dockerfiles: $FILES"
          fi

      - name: Lint Dockerfiles with hadolint
        if: steps.find.outputs.no_dockerfiles == 'false'
        uses: hadolint/hadolint-action@v3.1.0
        with:
          recursive: true
          failure-threshold: warning
          ignore: DL3008  # ignore "pin versions in apt-get" for dev images

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 â€” Validate config files exist
  # Ensures all required docker/ config files
  # are present and not empty
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-configs:
    name: Validate Config Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required config files exist
        run: |
          REQUIRED_FILES=(
            "docker/postgres/init-multiple-dbs.sh"
            "docker/prometheus/prometheus.yml"
            "docker/loki/loki-config.yaml"
            "docker/tempo/tempo-config.yaml"
            "docker/promtail/promtail-config.yaml"
            "docker/grafana/provisioning/datasources/datasources.yaml"
          )
          for f in "${REQUIRED_FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "âœ… $f exists"
            else
              echo "âŒ $f is MISSING"
              exit 1
            fi
          done

      - name: Check config files are not empty
        run: |
          REQUIRED_FILES=(
            "docker/prometheus/prometheus.yml"
            "docker/loki/loki-config.yaml"
            "docker/tempo/tempo-config.yaml"
            "docker/promtail/promtail-config.yaml"
            "docker/grafana/provisioning/datasources/datasources.yaml"
          )
          for f in "${REQUIRED_FILES[@]}"; do
            if [ -s "$f" ]; then
              echo "âœ… $f is not empty"
            else
              echo "âŒ $f is EMPTY"
              exit 1
            fi
          done

      - name: Check init script is executable
        run: |
          if [ -x "docker/postgres/init-multiple-dbs.sh" ]; then
            echo "âœ… init-multiple-dbs.sh is executable"
          else
            echo "âŒ init-multiple-dbs.sh is NOT executable â€” run: chmod +x docker/postgres/init-multiple-dbs.sh"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4 â€” Summary
  # Posts a summary to the PR / commit
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-compose, lint-dockerfiles, validate-configs]
    if: always()

    steps:
      - name: Post summary
        run: |
          echo "## ðŸ³ Docker Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate docker-compose.yml | ${{ needs.validate-compose.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Dockerfiles | ${{ needs.lint-dockerfiles.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Config Files | ${{ needs.validate-configs.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY